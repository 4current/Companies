---
title: "Amazon Analysis"
output:
  html_notebook:
    df_print: kable
---

```{r}
library(rvest)

#httr::set_config(httr::user_agent("r.morrisey@computer.org"))

# Define Functions

# get and cache data
getWSJWebData <- function(ticker, period, form) {
  fname <-
    paste('wsj',
          ticker,
          period,
          form,
          format(Sys.Date(), "%Y%m"),
          'tibble.rds',
          sep = '_')
  if (file.exists(fname)) {
    print('Reading saved tibble')
    wsj_tbl <- readRDS(fname)
  } else {
    print('Fetching data from WSJ')
    url <- paste(
      'https://www.wsj.com/market-data/quotes',
      ticker,
      'financials',
      period,
      form,
      sep = '/'
    )
    wsj_tbl <- NULL
    tables <- read_html(url) %>%
      html_elements('table.cr_dataTable')
    for (table in tables) {
      part <- table %>% html_table()
      colnames(part)[1] <- ""
      wsj_tbl <- rbind(wsj_tbl, part)
    }
    saveRDS(wsj_tbl, file = fname)
  }
  wsj_tbl
}

# Compound Annual Growth Rate
computeCAGR <- function(y, x) {
  n <- length(x) - 1
  (y[length(y)] / y[1]) ^ (1/n) - 1
}

# Get rid of commas and make numeric
my_text_to_num <- function(x) {
  y <- gsub(",", replacement = "", x)
  as.numeric(gsub('\\(([0-9.]+)\\)', '-\\1', y))
}

wsj_table_clean_format <- function(raw_table) {
  # Only the first 6 columns matter, after that there are unusable graphical components
  # Also delete rows with "" in column 1, they are for formatting purposes and contain
  # no data
  wsj_df <- as.data.frame(raw_table[raw_table[, 1] != "", 1:6])
  
  
  # The meaning of each row is in column 1. The year values are in the names of
  # columns 2-6, save and reverse the order The WSJ uses reverse chronological
  # order, we prefer chronological (ascending) order
  data_labels <- wsj_df[, 1]
  year_vals <- rev(colnames(wsj_df)[2:6])
  
  # Select only the year columns using the preferred order and then transpose
  #wsj_df <- transpose(wsj_df[,year_vals])
  wsj_df <- data.frame(t(wsj_df[, year_vals]))
  wsj_df <- cbind(year_vals, wsj_df)
  
  
  # Add back row and column names to the transposed data
  colnames(wsj_df) <- c('Year', data_labels)
  
  
  # Empty cells have a "-". Replace them with NA and delete all columns that have all NA.
  wsj_df[wsj_df == "-"] <- NA
  wsj_df <- wsj_df[, colSums(is.na(wsj_df)) < nrow(wsj_df)]
  
  
  # Delete columns with names that match "Growth" or "Margin" we can calculate those
  wsj_df <-
    wsj_df[,!grepl('(Growth|Margin|Yield| / Sales)$', colnames(wsj_df), ignore.case = TRUE)]
  data_labels <-  colnames(wsj_df)
  
  # Make values numeric but lapply/data.frame messes with names so fix
  wsj_df <- data.frame(lapply(wsj_df, 'my_text_to_num'))
  colnames(wsj_df) <- data_labels
  wsj_df
}

```

From https://www.wsj.com/market-data/quotes/AMZN/financials/annual/income-statement

## Analyze revenue growth - Top Line
```{r, results = 'asis' }

wsj_df <- wsj_table_clean_format(getWSJWebData(
  ticker = 'AMZN',
  period = 'annual',
  form = 'income-statement'
))

revenue <- as.numeric(gsub(",", "", wsj_df$`Sales/Revenue`))
#
barplot(
  signif(revenue / 1000, digits = 3),
  names.arg = wsj_df$Year,
  main = 'Amazon.com Sales/Revenue',
  xlab = 'Year',
  ylab = "Billion Dollars"
)

wsj_df

```
# Revenue Growth

```{r}

revenue_data <- wsj_df[, c('Year', 'Sales/Revenue')]
y <- length(revenue_data$Year)
revenue_data$growth[2:y] <- diff(revenue_data$`Sales/Revenue`)
revenue_data$growth_rate[2:y] <-
  revenue_data$growth[2:y] / revenue_data$`Sales/Revenue`[1:(y - 1)]
revenue_data

```

## Operating Expenses

In this section we calculate the net operating profit (NOP) and neta operating profit margin (NOPM).
The formula is:
$$NOP=Revenue-({CGS}+{SGA}+{R\&D})$$
and
$$NOPM=NOP/{OperatingRevenue}$$
Cost of Goods Sold (CGS), Selling, General and Administrative Expenses (SGA), Research and Development (RND). Operating revenue is revenue generated by the company's primary business operations.

```{r}

year <- wsj_df$Year
revenue <- wsj_df$`Sales/Revenue`
cgs <- wsj_df$`COGS excluding D&A`
sga <- wsj_df$`Other SG&A`
rnd <- wsj_df$`Research & Development`

nop <- revenue - (cgs + sga + rnd)
nopm <- nop / revenue
nopm_data <- data.frame(year, revenue, cgs, sga, rnd, nop, nopm)

nopm_data

```
## Averages Growth and NOPM
```{r}
periods <- 3
idx_range <- (length(year)-periods+1):length(year)
agr <- mean(revenue_data$growth_rate[idx_range])
cagr_range <- (length(year)-periods):length(year)

cagr <- computeCAGR(revenue[cagr_range],as.numeric(year[cagr_range]))
anopm <- mean(nopm[idx_range])

print(paste(periods,"Year Average Growth Rate", signif(agr, digits = 3)))
print(paste(periods,"Year Compound Average Growth Rate", signif(cagr, digits = 3)))
print(paste(periods,"Year Average Net Operating Profit Margin", signif(anopm, digits = 3)))
```
So not let's look at the company's projected NOP given an excess return period (ERP) of 7 years

## Excess Return Period

```{r}
ERP <- 7
future_years  <- seq(wsj_df$Year[length(wsj_df$Year)] + 1, length.out = ERP)
projected_revenue <- cumprod(c(wsj_df$`Sales/Revenue`[5], rep((1+cagr), ERP)))[2:(ERP + 1)]
nopm <- projected_revenue * anopm
nopm_df <- data.frame(year = future_years, revenue = projected_revenue, nopm = nopm)
print(nopm_df)
```

## Taxes
Figure out an average tax rate fom historical data. Depreciation and Amortization are factored in later.
Ity seems in some cases there is negative adjustments so lelt's exclude that for tha average.

```{r}
income_before_tax <- wsj_df$`Pretax Income`
income_taxes <- wsj_df$`Income Tax`
tax_rate <- income_taxes / income_before_tax
year <- wsj_df$Year
tax_table <- data.frame(year, income_before_tax, income_taxes, tax_rate)
print(tax_table)
```
```{r}
unadjusted_tax_rate <- mean(tax_table$tax_rate[2:4])
print(paste("Average Unadjusted Tax Rate: ", unadjusted_tax_rate ))
```

## NOPAT Table

```{r}
# for now ... unadjusted
tax_rate <- unadjusted_tax_rate
print(tax_rate)
nopat_table <- data.frame(year = nopm_df$year, 'nop' = nopm_df$nop, 'nopat' = nopm_df$nop * (1 - tax_rate))
rownames(nopat_table) <- future_years
nopat_table
```

## Investment and Depreciation Costs
```{r}

wsj_cf_df <- wsj_table_clean_format(
  getWSJWebData(ticker = 'AMZN', period = 'annual', form = 'cash-flow')
)
wsj_cf_df

```
```{r}
# Net Investment

year <- wsj_cf_df$Year

net_investment_df <- data.frame(
  Year = wsj_cf_df$Year,
  NewInvestment = -(wsj_cf_df$`Capital Expenditures` + wsj_cf_df$`Net Assets from Acquisitions` + wsj_cf_df$`Sale of Fixed Assets & Businesses` + wsj_cf_df$`Purchase of Investments` + wsj_cf_df$`Sale/Maturity of Investments`),
  PercentNewInvestment = NewInvestment / wsj_df$`Sales/Revenue`,
  DepreciationExpense = wsj_df$`Depreciation & Amortization Expense`,
  PercentDepreciation = DepreciationExpense / wsj_df$`Sales/Revenue`,
  NetInvestment = NewInvestment - DepreciationExpense 
)

net_investment_df

avg_period <- 3
i_end <- length(net_investment_df$Year)
i_start <- i_end - avg_period + 1
avg_deprecn_pct <- mean(net_investment_df$PercentDepreciation[i_start:i_end])
avg_invest_pct <- mean(net_investment_df$PercentNewInvestment[i_start:i_end])

print(paste("3-Year Average Depreciation Percentage: ", signif(avg_deprecn_pct * 100, 3)))
print(paste("3-Year Average Investment Percentage: ", signif(avg_invest_pct * 100, 3)))

ERP <- 7
future_years  <- seq(wsj_df$Year[length(wsj_df$Year)] + 1, length.out = ERP)
projected_revenue <- cumprod(c(wsj_df$`Sales/Revenue`[5], rep((1+cagr), ERP)))[2:(ERP + 1)]


projected_net_investment_df <- data.frame(
  Year = future_years,
  Revenue = projected_revenue,
  `New Investment` = projected_revenue * avg_invest_pct,
  Depreciation = projected_revenue * avg_deprecn_pct,
  `Net Investment` = projected_revenue * avg_invest_pct - projected_revenue * avg_deprecn_pct
)

projected_net_investment_df

```


```{r}
# Working Capital

wc <- -(wsj_cf_df$Receivables + wsj_cf_df$Inventories + wsj_cf_df$`Accounts Payable`)
pct_wc <- wc / wsj_df$`Sales/Revenue`

wc_df <- data.frame(
  Year = wsj_df$Year, 
  Revenue = wsj_df$`Sales/Revenue`,
  `Accounts Receivable` = wsj_cf_df$Receivables,
  Inventory = wsj_cf_df$Inventories,
  `Accounts Payable` = wsj_cf_df$`Accounts Payable`,
  `Working Capital` = wc,
  `Percent Working Capital` = pct_wc
)

wc_df

avg_period <- 3
i_end <- length(wc_df$Year)
i_start <- i_end - avg_period + 1
avg_wc_pct <- mean(wc_df$Percent.Working.Capital[i_start:i_end])

print(paste("3-Year Average Working Capital Percentage of revenue: ",
            signif(avg_wc_pct * 100, 3)))

ERP <- 7
future_years  <- seq(wsj_df$Year[length(wsj_df$Year)] + 1, length.out = ERP)
projected_revenue <- cumprod(c(wsj_df$`Sales/Revenue`[5], rep((1+cagr), ERP)))[2:(ERP + 1)]

incremental_wc_df <- data.frame(
  Year = future_years,
  Revenue = projected_revenue
  )
incremental_wc_df$`Incremental Revenue`[2:ERP] <- diff(projected_revenue)
incremental_wc_df$incremental_wc <- avg_wc_pct * incremental_wc_df$`Incremental Revenue`
#
incremental_wc_df
```
